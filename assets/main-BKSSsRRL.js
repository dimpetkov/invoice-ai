import{r as a,j as e,G as te,i as L,c as ie,R as re}from"./invoice-extraction-config-0N-MSPy6.js";const J="You are a helpful AI assistant named Gemini. Keep your responses concise and helpful. Format code snippets appropriately using markdown.",Q=[{id:"balanced",name:"Balanced",description:"Optimal blend of speed and reasoning for most tasks.",cost:"Standard",model:"gemini-2.5-flash",config:{systemInstruction:J}},{id:"lightning",name:"Lightning",description:"Prioritizes response speed, ideal for quick queries.",cost:"Lower",model:"gemini-2.5-flash",config:{systemInstruction:J,thinkingConfig:{thinkingBudget:0}}}],oe=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:[e.jsx("path",{fillRule:"evenodd",d:"M11.25 3.5A1.75 1.75 0 0 0 9.5 5.25v1.5H11v-1.5a.25.25 0 0 1 .25-.25h1.5a.25.25 0 0 1 .25.25v1.5h1.5v-1.5A1.75 1.75 0 0 0 12.75 3.5h-1.5Z",clipRule:"evenodd"}),e.jsx("path",{d:"M3 6.5A1.5 1.5 0 0 1 4.5 5h11A1.5 1.5 0 0 1 17 6.5v7a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 3 13.5v-7ZM4.5 6a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5h-11Z"}),e.jsx("path",{fillRule:"evenodd",d:"M8.75 16.5A1.75 1.75 0 0 0 10.5 14.75v-1.5H9v1.5a.25.25 0 0 1-.25.25h-1.5a.25.25 0 0 1-.25-.25v-1.5H5.5v1.5A1.75 1.75 0 0 0 7.25 16.5h1.5Z",clipRule:"evenodd"}),e.jsx("path",{d:"M8 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-7Z"})]}),ce=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{fillRule:"evenodd",d:"M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z",clipRule:"evenodd"})}),de=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5 text-blue-500",children:e.jsx("path",{fillRule:"evenodd",d:"M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z",clipRule:"evenodd"})}),me=({modes:l,selectedMode:u,onSelect:g})=>{const[d,c]=a.useState(!1),h=a.useRef(null);a.useEffect(()=>{const i=y=>{h.current&&!h.current.contains(y.target)&&c(!1)};return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[]);const f=i=>{g(i),c(!1)};return e.jsxs("div",{className:"relative",ref:h,children:[e.jsxs("button",{onClick:()=>c(!d),className:"flex items-center gap-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors","aria-haspopup":"true","aria-expanded":d,children:[e.jsx(oe,{}),e.jsx("span",{children:u.name}),e.jsx(ce,{})]}),d&&e.jsx("div",{className:"absolute top-full right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl z-20",children:e.jsx("div",{className:"p-2",children:l.map(i=>e.jsxs("div",{onClick:()=>f(i),className:"p-3 hover:bg-gray-700 rounded-md cursor-pointer",role:"option","aria-selected":u.id===i.id,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-semibold text-white",children:i.name}),e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-blue-600/30 text-blue-300 rounded-full",children:i.cost})]}),u.id===i.id&&e.jsx(de,{})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:i.description})]},i.id))})})]})},ue=[15,16,19,20,21,26,27,33,34,35,39,40,41],xe=ue.map(l=>l-1),he=l=>{const u=l.trim();if(u==="")return"";const g=u.match(/^(-?\d+)(\.(\d+))?$/);if(!g)return u;const d=g[1],c=g[3]||"";return c.length===0?`${d}.00`:c.length===1?`${d}.${c}0`:u},ge=()=>{const[l,u]=a.useState(null),[g,d]=a.useState(null),[c,h]=a.useState(!1),[f,i]=a.useState(null),[y,v]=a.useState(null),[_,D]=a.useState("4"),[B,P]=a.useState("СТОКИ"),[S,R]=a.useState("gemini-2.0-flash-exp"),[w,Z]=a.useState(""),[K,F]=a.useState(!1),G=a.useRef(null);a.useEffect(()=>{const t=localStorage.getItem("gemini_api_key"),s=localStorage.getItem("gemini_model");t&&Z(t),s&&R(s),t||F(!0)},[]);const V=(t,s)=>{t&&(localStorage.setItem("gemini_api_key",t),Z(t)),localStorage.setItem("gemini_model",s),R(s),F(!1),v(null)},n=t=>{var r;const s=(r=t.target.files)==null?void 0:r[0];if(s)if(u(s),i(null),v(null),s.type.startsWith("image/")){const o=new FileReader;o.onload=p=>{var N;d((N=p.target)==null?void 0:N.result)},o.readAsDataURL(s)}else d(null)},m=(t,s)=>{var I,T;const r=(I=L.extractionSettings)==null?void 0:I.delimiter,o=(T=L.extractionSettings)==null?void 0:T.minimumColumns,p=L.columns.slice(0,o).map((M,E)=>`${E+1}. ${M.name} - ${M.description}`).join(`
`),k={1:"Фактура продажба",2:"Дебитно известие продажба",3:"Кредитно известие продажба",4:"Фактура покупка",5:"Дебитно известие покупка",6:"Кредитно известие покупка",7:"Касови продажби",8:"Трансфер",9:"Брак (РАЗХОД)",10:"Брак (МОЛ)",11:"Складово искане",12:"Стокова разписка (СТ)",13:"Складова разписка (СР)",14:"Даване стоки на консигнация (КД) със счет. операции",15:"Даване стоки на консигнация (КД) без счет. операции"}[t]||"",O=`
ЛОГИКА ЗА ОПРЕДЕЛЯНЕ НА ПАРТНЬОРА СПОРЕД ВИД. ДОКУМЕНТ (${t}${k?` – ${k}`:""}):

- Ако Вид. Документ е 1, 2, 3 или 7 (фактура/известие продажба, касови продажби):
  • Нашата фирма е ИЗДАТЕЛ/ДОСТАВЧИК.
  • Партньор (колони 4–6) е ПОЛУЧАТЕЛ/КУПУВАЧ (клиентът).

- Ако Вид. Документ е 4, 5 или 6 (фактура/известие покупка):
  • Нашата фирма е ПОЛУЧАТЕЛ/КУПУВАЧ.
  • Партньор (колони 4–6) е ИЗДАТЕЛ/ДОСТАВЧИК (доставчикът).

- Ако Вид. Документ е от 8 до 15:
  • Ако документът съдържа външен контрагент (друга фирма извън нашата) – използвай него като Партньор (колони 4–6).
  • Ако документът е чисто вътрешен (между наши складове/обекти) – остави колони 4–6 празни.

Колона 4 „Партньор“ и колона 5 „ЕИК“ ВИНАГИ описват контрагента (другата страна по сделката), а не нашата фирма.
`.trim();return`Ти си експерт по извличане на данни от фактури и счетоводни документи за българската система Плюс Минус.

ВАЖНА ИНФОРМАЦИЯ:
- Тип документ (избран от потребителя): ${t}${k?` – ${k}`:""}
- Този номер ТРЯБВА да бъде поставен в КОЛОНА 1 (първата колона) на ВСЕКИ ред от извлечените данни.
- Вид на артикула (избран от потребителя): ${s}
- Тази стойност се използва от СИСТЕМАТА за попълване на колона 8 „Вид“. ТИ МОЖЕШ ДА ОСТАВИШ КОЛОНА 8 ПРАЗНА – системата ще я попълни автоматично.

${O}

Използвай инструкциите от спецификацията:
${L.extractionInstructions.map((M,E)=>`${E+1}. ${M}`).join(`
`)}

ЕДИН CSV РЕД = ЕДНА ПОЗИЦИЯ ОТ ДОКУМЕНТА:
- За ВСЯКА ПОЗИЦИЯ (артикул/ред от фактурата) създай отделен ред в CSV.
- Началните колони (1–${o}) са еднакви за всички редове на един и същ документ.
- Полетата за общи стойности (Обща стойност, ДДС, Платено и т.н.) се попълват САМО на ПЪРВИЯ ред за даден документ; на следващите редове се оставят празни.

CSV ФОРМАТ:
- Разделител между колоните: "${r}"
- Разделител на редовете: CRLF (\\r\\n)
- НЯМА заглавен ред – само редове с данни
- Логически работиш в UTF-8, но текстът трябва да е коректен на кирилица (по-късно файлът ще бъде записан като Windows-1251).

КОЛОНИ (МИНИМУМ ${o} колони, винаги в този ред за първите ${o}):
${p}

ДОПЪЛНИТЕЛНИ КОЛОНИ:
- В спецификацията има общо ${L.columns.length} колони.
- ЗАДЪЛЖИТЕЛНО попълвай колони 1–${o}, с изключение на колона 8, която може да бъде оставена празна – тя ще се попълни автоматично от системата.
- Ако имаш надеждни данни за колони след ${o}, добави ги в същия ред, в същия ред на колоните.
- Ако колона няма данни, остави я празна (две последователни "${r}").

ВАЛИДАЦИЯ:
${Object.entries(L.validationRules).map(([M,E])=>`- ${M}: ${E}`).join(`
`)}

ВАЖНИ ПРАВИЛА:
1. КОЛОНА 1 ВИНАГИ съдържа номера на типа документ: ${t}.
2. КОЛОНА 8 „Вид“ МОЖЕ ДА БЪДЕ ОСТАВЕНА ПРАЗНА – системата ще запише стойност ${s} за всеки ред.
3. Датите са във формат dd.mm.yyyy (с водещи нули).
4. Числата са без разделител за хилядите и без валутни символи (лв., €, $ и др.).
5. Не използвай символи " ' / \\ & в текстови полета.
6. Колона 4 „Партньор“ и колона 5 „ЕИК“ винаги описват контрагента (другата страна по сделката).

ИЗХОД:
Върни САМО CSV данните, без никакъв допълнителен текст, обяснения или markdown.
Започни директно с редовете с данни (БЕЗ заглавия).
Всеки ред ТРЯБВА да има МИНИМУМ ${o} стойности (колони), разделени с "${r}".
КОЛОНА 1 на всеки ред ТРЯБВА да съдържа: ${t}.
КОЛОНА 8 може да бъде празна – системата ще я попълни със стойност: ${s}.`},$=async()=>{var t,s,r,o,p,N,k,O;if(l){if(!_){v("Моля, изберете тип документ.");return}if(!w){v("Моля, въведете Gemini API ключ."),F(!0);return}h(!0),v(null),i(null);try{const I=new FileReader,T=await new Promise((A,j)=>{I.onload=C=>{var Y;const H=((Y=C.target)==null?void 0:Y.result).split(",")[1];A(H)},I.onerror=j,I.readAsDataURL(l)}),M=m(_,B);let E="";if(S==="gemini-2.5-flash"||S==="gemini-2.5-pro"){const A=`https://generativelanguage.googleapis.com/v1/models/${S}:generateContent?key=${w}`,j={contents:[{parts:[{text:M},{inline_data:{mime_type:l.type,data:T}}]}]},C=await fetch(A,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(j)});if(!C.ok){const H=await C.json();throw new Error(`Gemini API error: ${((t=H.error)==null?void 0:t.message)||C.statusText}`)}E=((N=(p=(o=(r=(s=(await C.json()).candidates)==null?void 0:s[0])==null?void 0:r.content)==null?void 0:o.parts)==null?void 0:p[0])==null?void 0:N.text)||""}else E=((await new te({apiKey:w}).chats.create({model:S}).sendMessage({message:[{text:M},{inlineData:{mimeType:l.type,data:T}}]})).text||"").trim();let U=E.trim();U.startsWith("```")&&(U=U.replace(/```csv\n?/gi,"").replace(/```\n?/g,"").trim());const W=((k=L.extractionSettings)==null?void 0:k.delimiter)||";",se=((O=L.extractionSettings)==null?void 0:O.minimumColumns)||21,q=U.split(/\r?\n/).map(A=>A.trim()).filter(A=>A.length>0);if(q.length===0){v("Моделът не върна валидни CSV данни."),i(null),h(!1);return}const ne=q.map(A=>{const j=A.split(W);for(;j.length<se;)j.push("");return xe.forEach(C=>{C<j.length&&(j[C]=he(j[C]))}),j[0]=_,j[7]="",j.join(W)}).join(`\r
`),le=`invoice_${l.name.split(".")[0]}_${Date.now()}.csv`;i({csv:ne,fileName:le})}catch(I){console.error(I),v(I instanceof Error?I.message:"Възникна грешка при обработката на документа. Моля, опитайте отново.")}finally{h(!1)}}},b=()=>{if(!f)return;const t=new Blob([f.csv],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),r=URL.createObjectURL(t);s.setAttribute("href",r),s.setAttribute("download",f.fileName),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)},x=()=>{u(null),d(null),i(null),v(null),G.current&&(G.current.value="")};return K?e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 shadow-lg",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Настройка на Gemini API"}),e.jsx("p",{className:"text-gray-400 mb-6",children:"Въведете вашия Gemini API ключ. Ключът се запазва локално във вашия браузър."}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-white font-medium mb-2",children:"Gemini API ключ:"}),e.jsx("input",{type:"password",value:w,onChange:t=>Z(t.target.value),className:"w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),y&&e.jsx("div",{className:"mb-4 p-3 bg-red-900/50 border border-red-500 rounded-lg",children:e.jsx("p",{className:"text-red-200 text-sm",children:y})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("button",{onClick:()=>V(w,S),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:"Запази"}),w&&e.jsx("button",{onClick:()=>F(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium",children:"Продължи"})]})]})}):e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 shadow-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Извличане на данни от фактура"})}),e.jsx("button",{onClick:()=>F(!0),className:"text-sm text-blue-400 hover:text-blue-300",children:"⚙️ API настройки"})]}),e.jsx("p",{className:"text-gray-400 mb-6",children:"Качете PDF или изображение на фактура за автоматично извличане на CSV, съвместим с Плюс Минус."}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm text-gray-300 mb-1",children:["Тип документ ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsxs("select",{value:_,onChange:t=>D(t.target.value),className:"w-full px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",disabled:c,children:[e.jsx("option",{value:"1",children:"1 - Фактура продажба"}),e.jsx("option",{value:"2",children:"2 - Дебитно известие продажба"}),e.jsx("option",{value:"3",children:"3 - Кредитно известие продажба"}),e.jsx("option",{value:"4",children:"4 - Фактура покупка"}),e.jsx("option",{value:"5",children:"5 - Дебитно известие покупка"}),e.jsx("option",{value:"6",children:"6 - Кредитно известие покупка"}),e.jsx("option",{value:"7",children:"7 - Касови продажби"}),e.jsx("option",{value:"8",children:"8 - Трансфер"}),e.jsx("option",{value:"9",children:"9 - Брак (РАЗХОД)"}),e.jsx("option",{value:"10",children:"10 - Брак (МОЛ)"}),e.jsx("option",{value:"11",children:"11 - Складово искане"}),e.jsx("option",{value:"12",children:"12 - Стокова разписка (СТ)"}),e.jsx("option",{value:"13",children:"13 - Складова разписка (СР)"}),e.jsx("option",{value:"14",children:"14 - Даване стоки на консигнация (КД) със счет. операции"}),e.jsx("option",{value:"15",children:"15 - Даване стоки на консигнация (КД) без счет. операции"})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Изберете типа на документа. Номерът ще бъде поставен в първата колона на всеки ред."})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm text-gray-300 mb-1",children:["Вид на артикула ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsxs("select",{value:B,onChange:t=>P(t.target.value),className:"w-full px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",disabled:c,children:[e.jsx("option",{value:"СТОКИ",children:"СТОКИ"}),e.jsx("option",{value:"УСЛУГИ",children:"УСЛУГИ"}),e.jsx("option",{value:"МАТЕРИАЛИ",children:"МАТЕРИАЛИ"}),e.jsx("option",{value:"ПРОДУКЦИЯ",children:"ПРОДУКЦИЯ"}),e.jsx("option",{value:"РАЗХОДИ ЗА МАТЕРИАЛИ",children:"РАЗХОДИ ЗА МАТЕРИАЛИ"}),e.jsx("option",{value:"АВАНС",children:"АВАНС"}),e.jsx("option",{value:"ПРИСПАВАНС",children:"ПРИСПАВАНС"})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Изберете вида на артикула. Стойността ще бъде записана в колона 8 (Вид) на всеки ред от системата."})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-1",children:"Gemini модел:"}),e.jsxs("select",{value:S,onChange:t=>{const s=t.target.value;R(s),V(w,s)},className:"w-full px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",disabled:c,children:[e.jsx("option",{value:"gemini-2.0-flash-exp",children:"Gemini 2.0 Flash – бърз и евтин"}),e.jsx("option",{value:"gemini-2.5-flash",children:"Gemini 2.5 Flash – подобрена точност"}),e.jsx("option",{value:"gemini-2.5-pro",children:"Gemini 2.5 Pro – най-точен"})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Изберете AI модела за обработка на документите."})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("input",{ref:G,type:"file",accept:"image/*,.pdf",onChange:n,className:"hidden"}),e.jsx("button",{onClick:()=>{var t;return(t=G.current)==null?void 0:t.click()},disabled:c,className:"w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors",children:l?"Смени файла":"Избери файл"})]}),l&&e.jsxs("div",{className:"mb-6 p-4 bg-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:l.name}),e.jsxs("p",{className:"text-gray-400 text-sm",children:[(l.size/1024).toFixed(2)," KB"]})]}),e.jsx("button",{onClick:x,className:"text-red-400 hover:text-red-300 text-sm",children:"Премахни"})]}),g&&e.jsx("img",{src:g,alt:"Preview",className:"max-w-full max-h-64 rounded-lg mx-auto"})]}),y&&e.jsx("div",{className:"mb-6 p-4 bg-red-900/50 border border-red-500 rounded-lg",children:e.jsx("p",{className:"text-red-200 text-sm",children:y})}),l&&!f&&e.jsx("button",{onClick:$,disabled:c,className:"w-full py-3 px-4 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors mb-6",children:c?"Обработва се…":"Извлечи данни"}),f&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"mb-4 p-4 bg-gray-900 rounded-lg",children:[e.jsx("h3",{className:"text-white font-medium mb-2",children:"CSV преглед:"}),e.jsx("pre",{className:"text-xs text-gray-300 overflow-x-auto bg-gray-950 p-3 rounded max-h-96 overflow-y-auto whitespace-pre",children:f.csv})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:b,className:"flex-1 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Изтегли CSV"}),e.jsx("button",{onClick:x,className:"flex-1 py-3 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors",children:"Нов документ"})]})]})]}),e.jsxs("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[e.jsx("h3",{className:"text-white font-medium mb-2",children:"Поддържани формати:"}),e.jsxs("ul",{className:"text-gray-400 text-sm space-y-1",children:[e.jsx("li",{children:"• PDF документи"}),e.jsx("li",{children:"• Изображения (JPG, PNG, WEBP)"}),e.jsx("li",{children:"• Фактури за услуги"}),e.jsx("li",{children:"• Множество файлове наведнъж"})]})]})]})},pe=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-white",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M12 4a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm-2.5 6.5a2.5 2.5 0 1 0 5 0 2.5 2.5 0 0 0-5 0ZM12 1a9 9 0 0 0-9 9v6.5a2.5 2.5 0 0 0 2.5 2.5h13A2.5 2.5 0 0 0 21 16.5V10a9 9 0 0 0-9-9Zm7 15.5H5a.5.5 0 0 1-.5-.5V10a7 7 0 0 1 14 0v6a.5.5 0 0 1-.5.5Z",clipRule:"evenodd"})}),fe=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-white",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M12 6a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm-5.5 9.5a1.5 1.5 0 0 1 1.5-1.5h8a1.5 1.5 0 0 1 1.5 1.5v.055A7.002 7.002 0 0 1 12 20a7.002 7.002 0 0 1-5.5-2.445V15.5ZM12 4a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11Z",clipRule:"evenodd"})}),ve=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-6 h-6",children:e.jsx("path",{d:"M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z"})}),be=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{fillRule:"evenodd",d:"M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z",clipRule:"evenodd"})}),z=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{fillRule:"evenodd",d:"M18.97 3.659a2.25 2.25 0 0 0-3.182 0l-10.94 10.94a3.75 3.75 0 1 0 5.304 5.303l7.693-7.693a.75.75 0 0 1 1.06 1.06l-7.693 7.693a5.25 5.25 0 1 1-7.424-7.424l10.939-10.94a3.75 3.75 0 1 1 5.303 5.304L9.097 18.835l-.008.008-.007.007-.002.002-.003.002A2.25 2.25 0 0 1 5.91 15.66l7.81-7.81a.75.75 0 0 1 1.061 1.06l-7.81 7.81a.75.75 0 0 0 1.054 1.068L18.97 6.84a2.25 2.25 0 0 0 0-3.182Z",clipRule:"evenodd"})}),X=()=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{fillRule:"evenodd",d:"M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z",clipRule:"evenodd"})}),je=()=>e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("div",{className:"h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"h-2 w-2 bg-gray-400 rounded-full animate-bounce"})]}),we=({message:l,isLoading:u,isStreaming:g})=>{const d=l.role==="user";return l.role==="system"?e.jsx("div",{className:"text-center text-sm text-gray-500 my-4 italic",children:l.text}):e.jsxs("div",{className:`flex items-start gap-3 ${d?"justify-end":""}`,children:[!d&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center mt-1",children:e.jsx(pe,{})}),e.jsxs("div",{className:`max-w-xl w-fit p-3 rounded-2xl ${d?"chat-bubble-gradient text-white rounded-br-lg":"bg-gray-700 text-gray-200 rounded-bl-lg"}`,children:[l.files&&l.files.length>0&&e.jsx("div",{className:"mb-2 flex flex-wrap gap-2",children:l.files.map((h,f)=>e.jsx("div",{className:"relative",children:h.preview?e.jsx("img",{src:h.preview,alt:h.name,className:"max-w-xs max-h-48 rounded-lg"}):e.jsxs("div",{className:"bg-gray-600 px-3 py-2 rounded-lg text-sm flex items-center gap-2",children:[e.jsx(z,{}),e.jsx("span",{className:"truncate max-w-[200px]",children:h.name})]})},f))}),e.jsxs("p",{className:"whitespace-pre-wrap break-words",children:[l.text,u&&g&&!d&&e.jsx("span",{className:"inline-block w-1 h-4 bg-white animate-pulse ml-1 align-middle","aria-label":"typing indicator"})]}),u&&!g&&!d&&e.jsx(je,{})]}),d&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center mt-1",children:e.jsx(fe,{})})]})};function ye(){const l={id:"init",role:"system",text:"Session started. Type a message to begin chatting with Gemini."},[u,g]=a.useState("chat"),[d,c]=a.useState([l]),[h,f]=a.useState(""),[i,y]=a.useState(!1),[v,_]=a.useState(Q[0]),[D,B]=a.useState([]),P=a.useRef(null),S=a.useRef(null),R=a.useRef(null),w=a.useRef(null);a.useEffect(()=>{var n;(n=S.current)==null||n.scrollTo({top:S.current.scrollHeight,behavior:"smooth"})},[d]),a.useEffect(()=>{R.current&&(R.current.style.height="auto",R.current.style.height=`${R.current.scrollHeight}px`)},[h]);const Z=()=>{P.current=null,c([l]),y(!1)},K=n=>{n.id!==v.id&&(_(n),P.current=null,c([{id:"mode-change-"+Date.now(),role:"system",text:`Model changed to ${n.name}. A new chat session has started.`}]),y(!1))},F=async n=>{const m=n.target.files;if(!m||m.length===0)return;const $=[];for(let b=0;b<m.length;b++){const x=m[b],t=new FileReader;await new Promise(s=>{t.onload=r=>{var k;const o=(k=r.target)==null?void 0:k.result,p=o.split(",")[1],N={name:x.name,type:x.type,data:p};x.type.startsWith("image/")&&(N.preview=o),$.push(N),s()},t.readAsDataURL(x)})}B(b=>[...b,...$]),w.current&&(w.current.value="")},G=n=>{B(m=>m.filter(($,b)=>b!==n))},V=async n=>{n.preventDefault();const m=h.trim();if(!m&&D.length===0||i)return;const $={id:Date.now().toString(),role:"user",text:m||"(attached files)",files:D.length>0?[...D]:void 0};c(x=>[...x,$]),f(""),B([]),y(!0);const b=(Date.now()+1).toString();c(x=>[...x,{id:b,role:"model",text:""}]);try{if(!P.current){const r=localStorage.getItem("gemini_api_key")||void 0;if(!r)throw new Error("API ключът не е конфигуриран. Моля, отидете в Invoice Extractor и въведете вашия Gemini API ключ в настройките.");const p=localStorage.getItem("gemini_model")||v.model,N=new te({apiKey:r});P.current=N.chats.create({model:p,config:v.config})}let x;if($.files&&$.files.length>0){const r=[];m&&r.push({text:m}),$.files.forEach(o=>{r.push({inlineData:{mimeType:o.type,data:o.data}})}),x={message:r}}else x={message:m};const t=await P.current.sendMessageStream(x);let s="";for await(const r of t)s+=r.text,c(o=>o.map(p=>p.id===b?{...p,text:s}:p))}catch(x){console.error(x);const t=x instanceof Error?x.message:"An unknown error occurred.",s={id:"error-"+Date.now(),role:"system",text:`Error: ${t}. Please check your API key configuration.`};c(r=>r.filter(o=>o.id!==b).concat(s))}finally{y(!1)}};return e.jsxs("div",{className:"bg-gray-900 text-gray-200 h-full flex flex-col antialiased",children:[e.jsxs("header",{className:"p-4 border-b border-gray-800 bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:"Invoice AI Tool"}),e.jsx("div",{className:"flex items-center gap-4",children:u==="chat"&&e.jsxs(e.Fragment,{children:[e.jsx(me,{modes:Q,selectedMode:v,onSelect:K}),e.jsxs("button",{onClick:Z,className:"flex items-center gap-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors",children:[e.jsx(be,{}),"New Chat"]})]})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>g("chat"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${u==="chat"?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:"Chat"}),e.jsx("button",{onClick:()=>g("invoice"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${u==="invoice"?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:"Invoice Extractor"})]})]}),u==="chat"?e.jsxs(e.Fragment,{children:[e.jsx("main",{ref:S,className:"flex-1 p-4 md:p-6 overflow-y-auto space-y-6",children:d.map((n,m)=>e.jsx(we,{message:n,isLoading:i&&m===d.length-1,isStreaming:n.text.length>0},n.id))}),e.jsx("footer",{className:"p-4 md:p-6 border-t border-gray-800 bg-gray-900",children:e.jsxs("form",{onSubmit:V,className:"max-w-3xl mx-auto",children:[D.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:D.map((n,m)=>e.jsx("div",{className:"relative group",children:n.preview?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:n.preview,alt:n.name,className:"h-20 w-20 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:()=>G(m),className:"absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(X,{})})]}):e.jsxs("div",{className:"relative bg-gray-700 px-3 py-2 rounded-lg text-sm flex items-center gap-2",children:[e.jsx(z,{}),e.jsx("span",{className:"truncate max-w-[150px]",children:n.name}),e.jsx("button",{type:"button",onClick:()=>G(m),className:"ml-2 text-red-400 hover:text-red-300",children:e.jsx(X,{})})]})},m))}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("input",{ref:w,type:"file",multiple:!0,accept:"image/*,.pdf,.txt,.doc,.docx",onChange:F,className:"hidden","aria-label":"File input"}),e.jsx("button",{type:"button",onClick:()=>{var n;return(n=w.current)==null?void 0:n.click()},disabled:i,className:"w-12 h-12 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Attach file",children:e.jsx(z,{})}),e.jsx("div",{className:"flex-1 bg-gray-800 rounded-2xl p-1 flex items-end",children:e.jsx("textarea",{ref:R,value:h,onChange:n=>f(n.target.value),onKeyDown:n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),V(n))},placeholder:"Message Gemini...",className:"w-full bg-transparent p-2 resize-none border-none focus:ring-0 focus:outline-none placeholder-gray-500 max-h-48",rows:1,disabled:i,"aria-label":"Chat input"})}),e.jsx("button",{type:"submit",disabled:i||!h.trim()&&D.length===0,className:"w-12 h-12 rounded-full flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed chat-bubble-gradient text-white","aria-label":"Send message",children:e.jsx(ve,{})})]})]})})]}):e.jsx("main",{className:"flex-1 overflow-y-auto",children:e.jsx(ge,{})})]})}const ee=document.getElementById("root");ee&&ie.createRoot(ee).render(e.jsx(re.StrictMode,{children:e.jsx(ye,{})}));
